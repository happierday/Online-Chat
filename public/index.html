<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Welcome to Chat Room</title>
        <link rel="stylesheet" type="text/css" href="./vendor/css/style.css">
        <script type = "text/javascript" src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>    
    </head>
    <body>
        <center>    
        <button id = "chat">chat</button>
        <div id="top">
            <button id = "loginButton" onclick="login()">login</button>
            <button id = "signoutButton" onclick= "signout()">signout</button>   
        </div>
        </center>
        <div class = "chatBox">
            <center>
            <div class = "chatTitle">
                <h1 id = "welcome">Welcome to this chat</h1>
                <h1 id = "welcomeUser">Welcome</h1>
            </div>  
            </center>  
            <div>
                <div id = "displayText"></div>
                <div id = "sendMessage">  
                    <textarea id = "chatMessage" type = "text" placeholder="type your message"></textarea>
                    <button  id = "sendButton" type = "submit" onclick="send()">send</button>
                <div>
            </div>
        </div>
        
        <script>
            let historyMessage = new Map();
            let config = {
                    apiKey: "AIzaSyCWdc5Q191idrN-TuzvfiwI0m34Rh1pv_U",
                    authDomain: "chat-600bc.firebaseapp.com",
                    databaseURL: "https://chat-600bc.firebaseio.com",
                    projectId: "chat-600bc",
                    storageBucket: "",
                    messagingSenderId: "962409650011"
                };
                firebase.initializeApp(config);

            let history = firebase.database().ref('history');
            let displayText = document.getElementById('displayText');
            let sendMessage = document.getElementById('sendMessage');
            let userDisplay = document.getElementById('username');
            let loginButton = document.getElementById('loginButton');
            let welcome = document.getElementById('welcome');
            let welcomeUser = document.getElementById('welcomeUser');

            sendMessage.addEventListener('submit',(e)=>{
                e.preventDefault();
                let key = e.which || e.keyCode;
                if(key === 13){    
                    send();
                }
            },false);

            function login(){
                let provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider).then((result)=>{
                    let user = result.user;
                    loginButton.setAttribute("style","display:none");
                    let username = user.displayName;
                    sessionStorage.setItem(0,username);
                    let db = firebase.database().ref('user');
                    db.once('value',(snap)=>{
                        try{
                            snap.forEach(function(element){
                                if(element.val().email == user.email){
                                    throw BreakException
                                }           
                            })
                            db.push({
                                email:user.email,
                                username:username,
                            })    
                        }catch(e){
                        }
                    })
                    let dbroom = firebase.database().ref('room');
                    dbroom.once('value',(snap)=>{
                        try{
                            snap.forEach(function(element){
                                if(element.val().username == user){
                                    throw BreakException
                                }           
                            })
                            dbroom.push({
                                username:user
                            })    
                        }catch(e){
                            
                        }      
                    })
                    location.reload();
                })
                
            }

            function signout(){
                sessionStorage.clear();
                firebase.auth().signOut();
                location.reload();  
            }

            firebase.auth().onAuthStateChanged((user)=>{
                if(user){
                    welcome.setAttribute('style',"display:none");
                    welcomeUser.setAttribute("style","display:block");
                    welcomeUser.appendChild(document.createTextNode(" " + firebase.auth().currentUser.displayName));
                    loginButton.setAttribute("style","display:none");
                }else{
                    loginButton.setAttribute("style","display:block");
                    welcomeUser.setAttribute("style","display:none");
                    welcomeUser.removeChild(welcomeUser.childNodes[0]);
                    welcome.setAttribute('style',"display:block");
                }
            })
            function send(){
                if(firebase.auth().currentUser==null){
                    alert("Please Log In first");
                }else{
                    let user = firebase.auth().currentUser.displayName;
                    let userMessage = document.getElementById('chatMessage')
                    history.push({
                        user: Date().substr(0,25) + user,
                        message:userMessage.value
                    })
                    userMessage.value = null;
                }   
            }
            let displayHistory = true;
            history.on('value',(snap)=>{
                snap.forEach((element)=>{
                    historyMessage.set(element.val().user,element.val().message);
                })
                if(historyMessage.size!=0){
                    if(!displayHistory){
                        let array = Array.from(historyMessage)[historyMessage.size-1];
                        displayMessage(array);
                    }else{
                        for(var i = 0; i<historyMessage.size;++i){
                            let array = Array.from(historyMessage)[i];
                            displayMessage(array);
                        }
                        displayHistory = false;;
                    }
                }
                let add  = setInterval(()=>{
                    displayText.addEventListener('wheel',()=>{
                        clearInterval(add);
                    })
                    let isScrollDown = displayText.scrollHeight - displayText.clientHeight <= displayText.scrollTop + 1;
                    if(!isScrollDown){
                        displayText.scrollTop = displayText.scrollHeight - displayText.clientHeight;
                    }
                },100)
            })
</script>
<script src = "./vendor/js/displayMessage.js"></script>
    </body>
</html>